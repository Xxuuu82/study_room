{"remainingRequest":"D:\\3\\软件工程\\项目\\study_room\\src\\main\\resources\\front\\front\\node_modules\\vue-loader\\lib\\index.js??vue-loader-options!D:\\3\\软件工程\\项目\\study_room\\src\\main\\resources\\front\\front\\src\\pages\\weigui\\shensu.vue?vue&type=style&index=0&id=ccfabb8a&scoped=true&lang=css&","dependencies":[{"path":"D:\\3\\软件工程\\项目\\study_room\\src\\main\\resources\\front\\front\\src\\pages\\weigui\\shensu.vue","mtime":1766223126694},{"path":"D:\\3\\软件工程\\项目\\study_room\\src\\main\\resources\\front\\front\\node_modules\\css-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\3\\软件工程\\项目\\study_room\\src\\main\\resources\\front\\front\\node_modules\\vue-loader\\lib\\loaders\\stylePostLoader.js","mtime":499162500000},{"path":"D:\\3\\软件工程\\项目\\study_room\\src\\main\\resources\\front\\front\\node_modules\\postcss-loader\\src\\index.js","mtime":499162500000},{"path":"D:\\3\\软件工程\\项目\\study_room\\src\\main\\resources\\front\\front\\node_modules\\cache-loader\\dist\\cjs.js","mtime":499162500000},{"path":"D:\\3\\软件工程\\项目\\study_room\\src\\main\\resources\\front\\front\\node_modules\\vue-loader\\lib\\index.js","mtime":499162500000}],"contextDependencies":[],"result":[{"type":"Buffer","data":"base64:CgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKCgoKDQovKiDmoLflvI/osIPmlbTvvJrovpPlhaXmoYbnmb3lupXjgIHnu4bovrnmoYbvvIzmm7TmjqXov5Hlm77kuozmoLflvI8gKi8NCkBtZWRpYSAobWF4LXdpZHRoOiA3NjhweCkgew0KICAuYWRkLXVwZGF0ZS1wcmV2aWV3IC5lbC1mb3JtLWl0ZW0gPj4+IC5lbC1mb3JtLWl0ZW1fX2xhYmVsIHsgd2lkdGg6IDEwMCUgIWltcG9ydGFudDsgdGV4dC1hbGlnbjogbGVmdCAhaW1wb3J0YW50OyBsaW5lLWhlaWdodDogMjRweCAhaW1wb3J0YW50OyBwYWRkaW5nOiAwIDAgOHB4IDAgIWltcG9ydGFudDsgfQ0KICAuYWRkLXVwZGF0ZS1wcmV2aWV3IC5lbC1mb3JtLWl0ZW0gPj4+IC5lbC1mb3JtLWl0ZW1fX2NvbnRlbnQgeyBtYXJnaW4tbGVmdDogMCAhaW1wb3J0YW50OyB9DQogIC5pbmZvLWl0ZW0geyBmbGV4LWRpcmVjdGlvbjogY29sdW1uICFpbXBvcnRhbnQ7IH0NCiAgLmluZm8taXRlbSA+IGRpdjpmaXJzdC1jaGlsZCB7IHdpZHRoOiAxMDAlICFpbXBvcnRhbnQ7IHRleHQtYWxpZ246IGxlZnQgIWltcG9ydGFudDsgcGFkZGluZy1yaWdodDogMCAhaW1wb3J0YW50OyBtYXJnaW4tYm90dG9tOiA1cHggIWltcG9ydGFudDsgfQ0KfQ0KLmFkZC11cGRhdGUtcHJldmlldyAuZWwtaW5wdXQgPj4+IC5lbC1pbnB1dF9faW5uZXIsDQouYWRkLXVwZGF0ZS1wcmV2aWV3IC5lbC1zZWxlY3QgPj4+IC5lbC1pbnB1dF9faW5uZXIsDQouYWRkLXVwZGF0ZS1wcmV2aWV3IC5lbC1kYXRlLWVkaXRvciA+Pj4gLmVsLWlucHV0X19pbm5lciB7DQogIGJvcmRlcjogMXB4IHNvbGlkICNlNmU2ZTY7DQogIGJvcmRlci1yYWRpdXM6IDRweDsNCiAgcGFkZGluZzogMCAxMnB4Ow0KICBvdXRsaW5lOiBub25lOw0KICBjb2xvcjogIzMzMzsNCiAgYmFja2dyb3VuZDogI2ZmZjsNCiAgd2lkdGg6IDEwMCU7DQogIGZvbnQtc2l6ZTogMTRweDsNCiAgaGVpZ2h0OiA0MHB4Ow0KICBib3gtc2l6aW5nOiBib3JkZXItYm94Ow0KfQ0KLmFkZC11cGRhdGUtcHJldmlldyAuZWwtdGV4dGFyZWEgPj4+IC5lbC10ZXh0YXJlYV9faW5uZXIgew0KICBib3JkZXI6IDFweCBzb2xpZCAjZTZlNmU2Ow0KICBib3JkZXItcmFkaXVzOiA0cHg7DQogIHBhZGRpbmc6IDEycHg7DQogIG91dGxpbmU6IG5vbmU7DQogIGNvbG9yOiAjMzMzOw0KICBiYWNrZ3JvdW5kOiAjZmZmOw0KICB3aWR0aDogMTAwJTsNCiAgZm9udC1zaXplOiAxNHB4Ow0KICBtaW4taGVpZ2h0OiAxMDBweDsNCiAgYm94LXNpemluZzogYm9yZGVyLWJveDsNCn0NCg=="},{"version":3,"sources":["shensu.vue"],"names":[],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAqXA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA","file":"shensu.vue","sourceRoot":"src/pages/weigui","sourcesContent":["<template>\r\n  <div\r\n      :style=\"{\r\n      width: '100%',\r\n      maxWidth: '1000px',\r\n      padding: '20px',\r\n      boxShadow: '0px 4px 10px 0px rgba(0,0,0,0.302)',\r\n      margin: '10px auto',\r\n      position: 'relative',\r\n      background: '#fff',\r\n      borderRadius: '8px',\r\n      boxSizing: 'border-box'\r\n    }\"\r\n  >\r\n    <!-- 面包屑导航 -->\r\n    <div :style=\"{ marginBottom: '20px', paddingBottom: '10px', borderBottom: '1px solid #e4e7ed' }\">\r\n      <el-breadcrumb :separator=\"'/'\" :style='{\"fontSize\":\"14px\",\"lineHeight\":\"1\",\"color\":\"#333\"}'>\r\n        <el-breadcrumb-item @click=\"$router.push('/index/home')\">首页</el-breadcrumb-item>\r\n        <el-breadcrumb-item @click=\"$router.push('/index/weigui')\">违规记录</el-breadcrumb-item>\r\n        <el-breadcrumb-item>违规申诉</el-breadcrumb-item>\r\n      </el-breadcrumb>\r\n    </div>\r\n\r\n    <!-- 违规记录基本信息展示区域 -->\r\n    <div :style=\"{ width: '100%', maxWidth: '800px', padding: '20px', margin: '0 auto 20px', background: '#f8f9fa', borderRadius: '8px', boxShadow: '0 1px 3px rgba(0, 0, 0, .05)' }\">\r\n      <h3 :style=\"{ margin: '0 0 15px 0', fontSize: '16px', color: '#333', fontWeight: '500' }\">违规记录信息</h3>\r\n\r\n      <div class=\"info-item\" :style=\"{ padding: '10px 0', display: 'flex', borderBottom: '1px dashed #e4e7ed' }\">\r\n        <div :style=\"{ width: '120px', textAlign: 'right', paddingRight: '15px', color: '#666', fontSize: '14px' }\">违规单号：</div>\r\n        <div :style=\"{ flex: 1, color: '#333', fontSize: '14px' }\">{{ ruleForm.weiguidanhao || '-' }}</div>\r\n      </div>\r\n\r\n      <div class=\"info-item\" :style=\"{ padding: '10px 0', display: 'flex', borderBottom: '1px dashed #e4e7ed' }\">\r\n        <div :style=\"{ width: '120px', textAlign: 'right', paddingRight: '15px', color: '#666', fontSize: '14px' }\">违规类型：</div>\r\n        <div :style=\"{ flex: 1, color: '#333', fontSize: '14px' }\">{{ ruleForm.weiguileixing || '-' }}</div>\r\n      </div>\r\n\r\n      <div class=\"info-item\" :style=\"{ padding: '10px 0', display: 'flex', borderBottom: '1px dashed #e4e7ed' }\">\r\n        <div :style=\"{ width: '120px', textAlign: 'right', paddingRight: '15px', color: '#666', fontSize: '14px' }\">违规时间：</div>\r\n        <div :style=\"{ flex: 1, color: '#333', fontSize: '14px' }\">{{ ruleForm.weiguiTime || '-' }}</div>\r\n      </div>\r\n\r\n      <div class=\"info-item\" :style=\"{ padding: '10px 0', display: 'flex', borderBottom: '1px dashed #e4e7ed' }\">\r\n        <div :style=\"{ width: '120px', textAlign: 'right', paddingRight: '15px', color: '#666', fontSize: '14px' }\">违规原因：</div>\r\n        <div :style=\"{ flex: 1, color: '#333', fontSize: '14px', whiteSpace: 'pre-wrap' }\">{{ ruleForm.weiguiReason || '-' }}</div>\r\n      </div>\r\n    </div>\r\n\r\n    <!-- 申诉表单区域 -->\r\n    <el-form class=\"add-update-preview\" ref=\"ruleForm\" :model=\"ruleForm\" :rules=\"rules\" label-width=\"120px\">\r\n      <el-form-item label=\"申诉单号\" prop=\"shensudanhao\" :style=\"{ width: '100%', maxWidth: '800px', padding: '10px', margin: '0 auto 10px', display: 'block', boxSizing: 'border-box' }\">\r\n        <el-input v-model=\"ruleForm.shensudanhao\" placeholder=\"申诉单号\" readonly></el-input>\r\n      </el-form-item>\r\n\r\n      <el-form-item label=\"申诉人学号\" prop=\"xuehao\" :style=\"{ width: '100%', maxWidth: '800px', padding: '10px', margin: '0 auto 10px', display: 'block', boxSizing: 'border-box' }\">\r\n        <el-input v-model=\"ruleForm.xuehao\" placeholder=\"申诉人学号\" clearable :readonly=\"ro.xuehao\"></el-input>\r\n      </el-form-item>\r\n\r\n      <el-form-item label=\"申诉人姓名\" prop=\"xingming\" :style=\"{ width: '100%', maxWidth: '800px', padding: '10px', margin: '0 auto 10px', display: 'block', boxSizing: 'border-box' }\">\r\n        <el-input v-model=\"ruleForm.xingming\" placeholder=\"申诉人姓名\" clearable :readonly=\"ro.xingming\"></el-input>\r\n      </el-form-item>\r\n\r\n      <el-form-item label=\"申诉人手机\" prop=\"shouji\" :style=\"{ width: '100%', maxWidth: '800px', padding: '10px', margin: '0 auto 10px', display: 'block', boxSizing: 'border-box' }\">\r\n        <el-input v-model=\"ruleForm.shouji\" placeholder=\"申诉人手机\" clearable :readonly=\"ro.shouji\"></el-input>\r\n      </el-form-item>\r\n\r\n      <el-form-item label=\"申诉时间\" prop=\"shensuTime\" :style=\"{ width: '100%', maxWidth: '800px', padding: '10px', margin: '0 auto 10px', display: 'block', boxSizing: 'border-box' }\">\r\n        <el-date-picker value-format=\"yyyy-MM-dd HH:mm:ss\" v-model=\"ruleForm.shensuTime\" type=\"datetime\" placeholder=\"选择申诉时间\" style=\"width: 100%;\" default-time=\"12:00:00\"></el-date-picker>\r\n      </el-form-item>\r\n\r\n      <el-form-item label=\"申诉原因\" prop=\"shensuReason\" :style=\"{ width: '100%', maxWidth: '800px', padding: '10px', margin: '0 auto 10px', display: 'block', boxSizing: 'border-box' }\">\r\n        <el-input v-model=\"ruleForm.shensuReason\" type=\"textarea\" placeholder=\"请详细描述申诉原因\" clearable :rows=\"8\" style=\"width: 100%;\"></el-input>\r\n      </el-form-item>\r\n\r\n      <el-form-item label=\"申诉诉求\" prop=\"shensuSuqiu\" :style=\"{ width: '100%', maxWidth: '800px', padding: '10px', margin: '0 auto 10px', display: 'block', boxSizing: 'border-box' }\">\r\n        <el-input v-model=\"ruleForm.shensuSuqiu\" type=\"textarea\" placeholder=\"请说明您的申诉诉求（如：撤销违规记录、减轻处罚等）\" clearable :rows=\"4\" style=\"width: 100%;\"></el-input>\r\n      </el-form-item>\r\n\r\n      <el-form-item :style=\"{ padding: '20px 0 0', margin: '0', textAlign: 'center', width: '100%' }\">\r\n        <el-button :loading=\"submitting\" type=\"primary\" @click=\"onSubmit\" :style=\"{ margin: '0 10px 10px', padding: '0 24px', height: '40px', borderRadius: '4px', fontSize: '14px', background: '#2e61e1', color: '#fff', border: 'none' }\">提交申诉</el-button>\r\n        <el-button @click=\"back\" :style=\"{ margin: '0 10px 10px', padding: '0 24px', height: '40px', borderRadius: '4px', fontSize: '14px', background: '#f5f7fa', color: '#666', border: '1px solid #e4e7ed' }\">返回</el-button>\r\n      </el-form-item>\r\n    </el-form>\r\n  </div>\r\n</template>\r\n\r\n<script>\r\nimport axios from 'axios';\r\n\r\nexport default {\r\n  data() {\r\n    return {\r\n      submitting: false,\r\n      id: \"\",\r\n      baseUrl: \"\",\r\n      ro: {\r\n        shensudanhao: false,\r\n        weiguidanhao: true,\r\n        weiguileixing: true,\r\n        weiguiTime: true,\r\n        weiguiReason: true,\r\n        xuehao: false,\r\n        xingming: false,\r\n        shouji: false,\r\n        shensuTime: false,\r\n        shensuReason: false,\r\n        shensuSuqiu: false,\r\n      },\r\n      userTableName: localStorage.getItem(\"UserTableName\"),\r\n      ruleForm: {\r\n        shensudanhao: \"SS\" + new Date().getTime(),\r\n        weiguidanhao: \"\",\r\n        weiguileixing: \"\",\r\n        weiguiTime: \"\",\r\n        weiguiReason: \"\",\r\n        xuehao: \"\",\r\n        xingming: \"\",\r\n        shouji: \"\",\r\n        shensuTime: \"\",\r\n        shensuReason: \"\",\r\n        shensuSuqiu: \"\",\r\n        shensuStatus: \"申诉中\",\r\n        shensuHandleStatus: \"未处理\"\r\n      },\r\n      rules: {\r\n        shensudanhao: [],\r\n        weiguidanhao: [{ required: true, message: \"违规单号不能为空\", trigger: \"blur\" }],\r\n        xuehao: [{ required: true, message: \"申诉人学号不能为空\", trigger: \"blur\" }],\r\n        xingming: [{ required: true, message: \"申诉人姓名不能为空\", trigger: \"blur\" }],\r\n        shouji: [{ validator: (r, v, c) => { if (!v) c(); else { const reg = /^1[3-9]\\d{9}$/; if (!reg.test(v)) c(new Error('请输入正确的手机号')); else c(); } }, trigger: \"blur\" }],\r\n        shensuTime: [{ required: true, message: \"请选择申诉时间\", trigger: \"change\" }],\r\n        shensuReason: [{ required: true, message: \"请详细描述申诉原因\", trigger: \"blur\" }, { min: 20, message: \"申诉原因至少填写20个字\", trigger: \"blur\" }],\r\n        shensuSuqiu: [{ required: true, message: \"请说明您的申诉诉求\", trigger: \"blur\" }]\r\n      }\r\n    };\r\n  },\r\n  created() {\r\n    this.baseUrl = this.$config?.baseUrl || '';\r\n    this.ruleForm.shensuTime = new Date().toISOString().slice(0, 19).replace('T', ' ');\r\n    this.initShensuData();\r\n    this.initUserInfo();\r\n  },\r\n  methods: {\r\n    getAuthHeaders() {\r\n      const token = localStorage.getItem('Token') || localStorage.getItem('token') || localStorage.getItem('Authorization') || '';\r\n      const headers = {};\r\n      if (token) {\r\n        headers['Authorization'] = token.startsWith('Bearer ') ? token : `Bearer ${token}`;\r\n        headers['Token'] = token;\r\n      }\r\n      return headers;\r\n    },\r\n\r\n    async initShensuData() {\r\n      const routeId = this.$route && (this.$route.query.id || this.$route.params.id);\r\n      if (routeId) { await this.fetchWeiguiDetail(routeId); return; }\r\n\r\n      const stored = localStorage.getItem(\"currentWeiguiObj\");\r\n      if (stored) {\r\n        try {\r\n          const obj = JSON.parse(stored);\r\n          const id = obj.id || obj.ID;\r\n          if (id) { await this.fetchWeiguiDetail(id); return; }\r\n          this.fillRuleFormFromObj(obj);\r\n          return;\r\n        } catch (e) {\r\n          console.warn('currentWeiguiObj parse error', e);\r\n        }\r\n      }\r\n\r\n      this.$message.warning(\"未获取到违规记录信息，请选择要申诉的违规记录\");\r\n      setTimeout(() => this.$router.push('/index/weigui'), 1200);\r\n    },\r\n\r\n    async fetchWeiguiDetail(id) {\r\n      try {\r\n        console.log('[DEBUG] 正在请求 /api/weigui/detail id=', id);\r\n        const resp = await axios.get('/api/weigui/detail', {\r\n          params: { id },\r\n          headers: this.getAuthHeaders(),\r\n          withCredentials: true\r\n        });\r\n        console.log('[DEBUG] /api/weigui/detail 返回:', resp && resp.data);\r\n\r\n        const data = resp && resp.data;\r\n        if (data && (data.code === 401 || resp.status === 401)) {\r\n          this.$message.warning('请先登录，再查看违规详情');\r\n          setTimeout(() => { this.$router.push('/login'); }, 800);\r\n          return;\r\n        }\r\n\r\n        let record = null;\r\n        if (data) {\r\n          if (data.code === 0 && data.data) record = data.data;\r\n          else if (data.data && data.data.data) record = data.data.data;\r\n          else if (data.record) record = data.record;\r\n          else record = data;\r\n        }\r\n\r\n        if (!record || Object.keys(record).length === 0) {\r\n          console.warn('fetchWeiguiDetail: 未检测到 record，在 localStorage 回退');\r\n          const stored = localStorage.getItem(\"currentWeiguiObj\");\r\n          if (stored) { try { this.fillRuleFormFromObj(JSON.parse(stored)); } catch (e) { console.warn('回退 localStorage parse error', e); } return; }\r\n          this.$message.error('未能获取到违规详情');\r\n          setTimeout(() => this.$router.push('/index/weigui'), 1000);\r\n          return;\r\n        }\r\n\r\n        this.fillRuleFormFromObj(record);\r\n        try { localStorage.setItem(\"currentWeiguiObj\", JSON.stringify(record)); }\r\n        catch (e) { console.warn('localStorage set currentWeiguiObj failed', e); }\r\n\r\n      } catch (err) {\r\n        console.error('fetchWeiguiDetail 出错：', err);\r\n        if (err.response && err.response.status === 401) {\r\n          this.$message.warning('请先登录');\r\n          setTimeout(() => this.$router.push('/login'), 800);\r\n          return;\r\n        }\r\n        const stored = localStorage.getItem(\"currentWeiguiObj\");\r\n        if (stored) { try { this.fillRuleFormFromObj(JSON.parse(stored)); } catch (e) { console.warn('回退 localStorage parse error', e); } return; }\r\n        this.$message.error('无法获取违规详情，请稍后重试');\r\n        setTimeout(() => this.$router.push('/index/weigui'), 1200);\r\n      }\r\n    },\r\n\r\n    fillRuleFormFromObj(r) {\r\n      if (!r) return;\r\n      const getField = (...names) => {\r\n        for (const n of names) if (r[n] !== undefined && r[n] !== null && r[n] !== '') return r[n];\r\n        return null;\r\n      };\r\n      this.ruleForm.weiguidanhao = getField('weiguiDanhao','weiguidanhao','weigui_danhao') || this.ruleForm.weiguidanhao;\r\n      this.ruleForm.weiguileixing = getField('weiguileixingName','weiguileixing','weiguiLeixing') || '';\r\n      const rawTime = getField('weiguiShijian','weigui_shijian','addtime','addTime');\r\n      this.ruleForm.weiguiTime = this.formatAnyTime(rawTime) || '';\r\n      this.ruleForm.weiguiReason = getField('weiguiBeizhu','weigui_beizhu','otherWeiguiDesc') || '';\r\n      const recXuehao = getField('xuehao','XUEHAO');\r\n      const recXingming = getField('xingming','XINGMING','name');\r\n      if (recXuehao) { this.ruleForm.xuehao = recXuehao; this.ro.xuehao = true; }\r\n      if (recXingming) { this.ruleForm.xingming = recXingming; this.ro.xingming = true; }\r\n    },\r\n\r\n    initUserInfo() {\r\n      if (!this.userTableName) {\r\n        if (!this.ruleForm.xuehao) this.ruleForm.xuehao = \"20230001\";\r\n        if (!this.ruleForm.xingming) this.ruleForm.xingming = \"张三\";\r\n        if (!this.ruleForm.shouji) this.ruleForm.shouji = \"13800138000\";\r\n        this.ro.xuehao = true; this.ro.xingming = true; this.ro.shouji = true;\r\n        return;\r\n      }\r\n      if (this.$http) {\r\n        this.$http.get(this.userTableName + \"/session\", { emulateJSON: true })\r\n            .then((res) => {\r\n              if (res.data && (res.data.code === 0 || res.data.success === true)) {\r\n                const userInfo = res.data.data || {};\r\n                if (userInfo.xuehao) { this.ruleForm.xuehao = userInfo.xuehao; this.ro.xuehao = true; }\r\n                if (userInfo.xingming) { this.ruleForm.xingming = userInfo.xingming; this.ro.xingming = true; }\r\n                if (userInfo.shouji) { this.ruleForm.shouji = userInfo.shouji; this.ro.shouji = true; }\r\n              }\r\n            })\r\n            .catch(err => { console.warn(\"获取用户信息失败：\", err); });\r\n      }\r\n    },\r\n\r\n    // ========== 提交到后端 ==========\r\n    async onSubmit() {\r\n      this.$refs[\"ruleForm\"].validate(async (valid) => {\r\n        if (!valid) return;\r\n        if (this.submitting) return;\r\n        this.submitting = true;\r\n\r\n        let current = {};\r\n        try { current = JSON.parse(localStorage.getItem(\"currentWeiguiObj\") || \"{}\"); } catch (e) { console.warn('parse currentWeiguiObj failed', e); }\r\n\r\n        // 注意：数据库表没有 weiguiDanhao 字段，所以不提交该字段。\r\n        // 数据库存在 shensuTupian, shensuNeirong, shensuShijian 等字段。\r\n        // 这里把前端的 shensuSuqiu (申诉诉求) 映射到 shensuTupian（如果你需要映射到其它字段，请调整）\r\n        const payload = {\r\n          shensuDanhao: this.ruleForm.shensudanhao,\r\n          xuehao: this.ruleForm.xuehao,\r\n          xingming: this.ruleForm.xingming,\r\n          shensuNeirong: this.ruleForm.shensuReason,\r\n          shensuTupian: this.ruleForm.shensuSuqiu || '',\r\n          shensuShijian: this.ruleForm.shensuTime || new Date().toISOString().slice(0,19).replace('T',' '),\r\n          weiguiRecordId: current.id || null\r\n        };\r\n\r\n        console.log('[DEBUG] 发送申诉 payload=', payload);\r\n\r\n        try {\r\n          const resp = await axios.post('/api/shensu/add', payload, {\r\n            headers: { 'Content-Type': 'application/json;charset=UTF-8', ...this.getAuthHeaders() },\r\n            withCredentials: true\r\n          });\r\n\r\n          console.log('[DEBUG] /api/shensu/add 返回：', resp && resp.data);\r\n\r\n          const data = resp && resp.data;\r\n          const ok = (data && (data.code === 0 || data.code === 200 || data.success === true)) || resp.status === 200;\r\n\r\n          if (ok) {\r\n            this.$message({\r\n              message: \"申诉提交成功，等待管理员审核处理\",\r\n              type: \"success\",\r\n              duration: 2000,\r\n              onClose: () => { this.$router.push('/index/weigui'); }\r\n            });\r\n            try {\r\n              const stored = JSON.parse(localStorage.getItem(\"currentWeiguiObj\") || \"{}\");\r\n              if (stored) { stored.shensuStatus = \"已申诉\"; stored.shensuHandleStatus = \"处理中\"; localStorage.setItem(\"currentWeiguiObj\", JSON.stringify(stored)); }\r\n            } catch (e) { console.warn('update localStorage currentWeiguiObj failed', e); }\r\n          } else {\r\n            const msg = (data && (data.msg || data.message)) || '申诉提交失败';\r\n            this.$message.error(msg);\r\n          }\r\n        } catch (err) {\r\n          console.error('申诉提交请求出错：', err);\r\n          if (err.response && err.response.status === 401) {\r\n            this.$message.warning('请先登录再提交申诉');\r\n            setTimeout(()=> this.$router.push('/login'), 800);\r\n          } else {\r\n            this.$message.error('网络或服务器错误，提交失败');\r\n          }\r\n        } finally {\r\n          this.submitting = false;\r\n        }\r\n      });\r\n    },\r\n\r\n    getUUID() { return \"SS\" + new Date().getTime(); },\r\n\r\n    back() { this.$router.push('/index/weigui'); },\r\n\r\n    formatAnyTime(val) {\r\n      if (!val && val !== 0) return '';\r\n      if (Array.isArray(val)) { const arr = val.map(v=>String(v).padStart(2,'0')); if (arr.length>=6) return `${arr[0]}-${arr[1]}-${arr[2]} ${arr[3]}:${arr[4]}:${arr[5]}`; return arr.join('-'); }\r\n      if (typeof val === 'number') { if (String(val).length===10) return new Date(val*1000).toISOString().replace('T',' ').slice(0,19); return new Date(val).toISOString().replace('T',' ').slice(0,19); }\r\n      if (val instanceof Object && !(val instanceof Date)) {\r\n        try {\r\n          const asStr = String(val);\r\n          if (asStr && asStr.indexOf('[')===0) return asStr;\r\n          return asStr;\r\n        } catch(e) {\r\n          // 避免 ESLint no-empty，记录并返回原始值字符串\r\n          console.warn('formatAnyTime parse error', e);\r\n          return String(val);\r\n        }\r\n      }\r\n      try { const s = String(val).trim(); if (/^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}/.test(s)) return s.replace('T',' ').slice(0,19); return s; } catch(e){ return String(val); }\r\n    },\r\n\r\n    parseDateStr(str) {\r\n      if (!str && str !== 0) return null;\r\n      if (str instanceof Date) return str;\r\n      if (typeof str === 'number') return new Date(str);\r\n      if (Array.isArray(str)) { const arr = str.map(n=>Number(n)); if (arr.length>=6) return new Date(arr[0], arr[1]-1, arr[2], arr[3], arr[4], arr[5]); return null; }\r\n      let s = String(str).trim();\r\n      if (/^\\d{10}$/.test(s)) return new Date(Number(s)*1000);\r\n      if (/^\\d{13}$/.test(s)) return new Date(Number(s));\r\n      if (/^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}$/.test(s)) s = s.replace(' ', 'T');\r\n      if (/^\\d{4}\\/\\d{2}\\/\\d{2} \\d{2}:\\d{2}:\\d{2}$/.test(s)) s = s.replace(' ', 'T').replace(/\\//g, '-');\r\n      const d = new Date(s); if (isNaN(d.getTime())) return null; return d;\r\n    },\r\n\r\n    formatEndTime(endDate) {\r\n      const d = endDate instanceof Date ? endDate : new Date(endDate); if (isNaN(d.getTime())) return ''; const pad = n=> (n<10? '0'+n : ''+n); return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;\r\n    }\r\n  }\r\n};\r\n</script>\r\n\r\n<style scoped>\r\n/* 样式调整：输入框白底、细边框，更接近图二样式 */\r\n@media (max-width: 768px) {\r\n  .add-update-preview .el-form-item >>> .el-form-item__label { width: 100% !important; text-align: left !important; line-height: 24px !important; padding: 0 0 8px 0 !important; }\r\n  .add-update-preview .el-form-item >>> .el-form-item__content { margin-left: 0 !important; }\r\n  .info-item { flex-direction: column !important; }\r\n  .info-item > div:first-child { width: 100% !important; text-align: left !important; padding-right: 0 !important; margin-bottom: 5px !important; }\r\n}\r\n.add-update-preview .el-input >>> .el-input__inner,\r\n.add-update-preview .el-select >>> .el-input__inner,\r\n.add-update-preview .el-date-editor >>> .el-input__inner {\r\n  border: 1px solid #e6e6e6;\r\n  border-radius: 4px;\r\n  padding: 0 12px;\r\n  outline: none;\r\n  color: #333;\r\n  background: #fff;\r\n  width: 100%;\r\n  font-size: 14px;\r\n  height: 40px;\r\n  box-sizing: border-box;\r\n}\r\n.add-update-preview .el-textarea >>> .el-textarea__inner {\r\n  border: 1px solid #e6e6e6;\r\n  border-radius: 4px;\r\n  padding: 12px;\r\n  outline: none;\r\n  color: #333;\r\n  background: #fff;\r\n  width: 100%;\r\n  font-size: 14px;\r\n  min-height: 100px;\r\n  box-sizing: border-box;\r\n}\r\n</style>"]}]}